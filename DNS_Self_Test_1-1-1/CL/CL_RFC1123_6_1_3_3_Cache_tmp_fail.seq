#!/usr/bin/perl
#
# Copyright (C) 2006 Yokogawa Electric Corporation.
# All rights reserved.
# 
# Redistribution and use of this software in source and binary
# forms, with or without modification, are permitted provided that
# the following conditions and disclaimer are agreed and accepted
# by the user:
# 
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in
#    the documentation and/or other materials provided with
#    the distribution.
# 
# 3. Neither the names of the copyrighters, the name of the project
#    which is related to this software (hereinafter referred to as
#    "project") nor the names of the contributors may be used to
#    endorse or promote products derived from this software without
#    specific prior written permission.
# 
# 4. No merchantable use may be permitted without prior written
#    notification to the copyrighters.
# 
# 5. The copyrighters, the project and the contributors may prohibit
#    the use of this software at any time.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHTERS, THE PROJECT AND
# CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING
# BUT NOT LIMITED THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
# FOR A PARTICULAR PURPOSE, ARE DISCLAIMED.  IN NO EVENT SHALL THE
# COPYRIGHTERS, THE PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING
# IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#
# $TAHI: ct-dns/dns/CL/CL_RFC1123_6_1_3_3_Cache_tmp_fail.seq,v 1.1.1.1 2006/06/02 05:15:41 akisada Exp $
# $Id: CL_RFC1123_6_1_3_3_Cache_tmp_fail.seq,v 1.1.1.1 2006/06/02 05:15:41 akisada Exp $
#
######################################################################

BEGIN {
        $kCommon::TestVersion = '$Name: REL_1_1_1 $';
        push( @INC, '/usr/local/koi/libdata' );
        push( @INC, '..' );
}

END {
}

# use strict;
use DNS;

#------------------------------#
# Query configuration          #
#------------------------------#
my $QueryConfig_1={ 
#mode
	'ModeRemoteAsync' => 'yes',
	'ModeRequiredTestMode' => 'client',
	'ModeManualNoPause' => 'yes',
#query
	'Query0Mode' => 'dns',
	'Query0Addr0' => $TN_NET1_NODE2_ADDR,
	'Query0Protocol' => 'UDP',
	'Query0Tries' => $RETRANSMIT_COUNT_CLIENT,
	'Query0Type' => 'A',
	'Query0Class' => 'IN',
	'Query0Value' => 'A.example.com',   
};

my $QueryConfig_2={ 
#mode
		      'ModeRequiredTestMode' => 'client',
		      'ModeManualNoPause' => 'yes',
#query
		      'Query0Mode' => 'dns',
		      'Query0Addr0' => $TN_NET1_NODE2_ADDR,
		      'Query0Protocol' => 'UDP',
		      'Query0Type' => 'A',
		      'Query0Class' => 'IN',
		      'Query0Value' => 'A.example.com',   
};

#------------------------------#
# configuration                #
#------------------------------#
my @dns_session_config = ();
my $dns_param          = { 'dns_session_config' => \@dns_session_config };

$dns_session_config[0] = {
        'TN_INTERFACE'   => 'Link0',
        'TN_ADDR'        => $TN_NET1_NODE2_ADDR,
        'TN_ADDR_PORT'   => $TN_SV_PORT,
        'TN_ADDR_PROTO'  => 'UDP',
        'TN_ADDR_FAMILY' => $ADDR_FAMILY,
        'NUT_ADDR'       => $NUT_ADDR_0,
        'NUT_ADDR_PORT'  => $NUT_SV_PORT
};

$dns_session_config[1] = {
        'TN_INTERFACE'   => 'Link0',
        'TN_ADDR'        => $TN_NET1_NODE2_ADDR,
        'TN_ADDR_PORT'   => $TN_SV_PORT,
        'TN_ADDR_PROTO'  => 'UDP',
        'TN_ADDR_FAMILY' => $ADDR_FAMILY,
        'NUT_ADDR'       => $NUT_ADDR_0,
        'NUT_ADDR_PORT'  => $NUT_SV_PORT
};

my @dns_session   = ();
my @exp_dns_msg_0 = ();
my @exp_dns_msg_1 = ();

$dns_session[0] = {
        'socket_ref'      => undef,
        'dns_one_session' => [
                {
                        'gen_dns_msg' => undef,
                        'dec_dns_msg' => undef,
                        'exp_dns_msg' => \@exp_dns_msg_0
                }
        ]
};

$dns_session[1] = {
        'socket_ref'      => undef,
        'dns_one_session' => [
                {
                        'gen_dns_msg' => undef,
                        'dec_dns_msg' => undef,
                        'exp_dns_msg' => \@exp_dns_msg_0
                }
        ]
};

#
# expected packet definition
#

#-------------------------
# 1st ( NUT->TN(NS1) )
#-------------------------
$exp_dns_msg_0[0]->{'header'} = {    # 1st packet header
        'id'      => undef,
        'qr'      => 0,
        'opcode'  => 0,
        'aa'      => undef,
        'tc'      => 0,
        'rd'      => undef,
        'ra'      => undef,
        'z'       => 0,
        'rcode'   => undef,
        'qdcount' => 1,
        'ancount' => 0,
        'nscount' => 0,
        'arcount' => 0,
};

$exp_dns_msg_0[0]->{'question'}->[0] = {
        'qname'  => 'A.example.com.',
        'qtype'  => 0x0001,
        'qclass' => undef,
};

################################
# start tests                  #
################################
my $ret = DNSStartConnect( $dns_param, \@dns_session );
unless ( defined($ret) ) {
        Debug_Print("ERROR:DNSStartConnect\n");
        DNSExit($FAIL);
}

#------------------------------#
# Send Query from Nut          #
#------------------------------#
my $remoteRet = DNSRemote("runquery.rmt",$QueryConfig_1);
unless ( defined($remoteRet) ) {
        Debug_Print("ERROR:DNSRemote\n");
        DNSExit($FAIL);
}

Print_Message(
        "=",
        [
                "Run query command on NUT\n",
		"\tNAME SERVER ADDRESS : 192.168.1.20\n",
                "\tQNAME               : A.example.com\n",
                "\tQTYPE               : A\n",
		"\tQCLASS              : ANY\n",
		"\tTRANSPORT PROTOCOL  : UDP\n",
        ]
);

#------------------------------#
# 1st-Nth packet (receive)     #
#------------------------------#
# defined in DNSConfig.pm
my $DNSQuery_Retry_Max = $RETRANSMIT_COUNT_CLIENT;

$ret = undef;
$ret = DNSRecv(
        $DNSQuery_Retry_Max, 60,
        $dns_session[0]->{'socket_ref'},
        $dns_session[0]->{'dns_one_session'}->[0]
);

unless ( defined($ret) ) {
        Debug_Print("ERROR: Can't receive DNS message\n");
        DNSExit($FAIL);
}

#------------------------------#
# Judgment (Nth packet)        #
#------------------------------#
for ( my $i = 1 ; $i <= $DNSQuery_Retry_Max ; $i++ ) {
        Print_Message(
                "#",
                [
                        "Judgment (${i}th packet)\n",
                        "${i}. Received standard query from NUT.\n",
                ]
        );

        my $recv_data =
          $dns_session[0]->{'dns_one_session'}->[0]->{'dec_dns_msg'}
          ->[ $i - 1 ];

        $ret = undef;
        $ret = JudgeDNSMsg( $recv_data, $exp_dns_msg_0[0] );
        unless ( defined($ret) ) {
                DNSExit($FAIL);
        }
        Print_Message( "=", ["${i}th packet PASS\n"] );
}

#-----------------------------------------------#
# N+1 packet (receive)                          #
#-----------------------------------------------#
$DNSQuery_Retry_Max++;
$ret = undef;
$ret = DNSRecv(
        1, 10,
        $dns_session[0]->{'socket_ref'},
        $dns_session[0]->{'dns_one_session'}->[0]
);

Print_Message(
        "#",
        [
                "Judgment (${DNSQuery_Retry_Max}th packet)\n",
"${DNSQuery_Retry_Max}. Not received standard query from NUT.\n",
        ]
);

if ( defined($ret) ) {
        #Print_Message( "=", ["Receive ${DNSQuery_Retry_Max}th message\n"] );
        Debug_Print(
                "ERROR:Client Send Query beyond Max times:$DNSQuery_Retry_Max"
                  . "\n" );
        DNSExit($FAIL);
} else {
        Print_Message( "=",
                ["Doesn't Recv ${DNSQuery_Retry_Max}th message\n"] );
}

Print_Message( "=", ["${DNSQuery_Retry_Max}th packet PASS\n"] );


{
		use kCommon;
	unless (defined(kRemoteAsyncWait())) {
		DNSExit($FAIL);
	}
}

#------------------------------#
# Send Query from Nut          #
#------------------------------#
$remoteRet = undef;
$remoteRet = DNSRemote("runquery.rmt",$QueryConfig_2);
unless ( defined($remoteRet) ) {
        Debug_Print("ERROR:DNSRemote\n");
        DNSExit($FAIL);
}

Print_Message(
        "=",
        [
                "Run query command on NUT\n",
                "\tQNAME : A.example.com\n",
                "\tQTYPE : A\n",
        ]
);

#-----------------------------------------------#
# N+2 packet (receive)                          #
#-----------------------------------------------#

$DNSQuery_Retry_Max++;
$ret = undef;
$ret = DNSRecv(
        1, 10,
        $dns_session[1]->{'socket_ref'},
        $dns_session[1]->{'dns_one_session'}->[0]
);

Print_Message(
        "#",
        [
                "Judgment (${DNSQuery_Retry_Max}th packet)\n",
"${DNSQuery_Retry_Max}. Not received standard query from NUT.\n",
        ]
);

if ( defined($ret) ) {
        #Print_Message( "=", ["Receive ${DNSQuery_Retry_Max}th message\n"] );
        Debug_Print(
                "ERROR:Client Send Query beyond Max times:$DNSQuery_Retry_Max"
                  . "\n" );
        DNSExit($FAIL);
} else {
        Print_Message( "=",
                ["Doesn't Recv ${DNSQuery_Retry_Max}th message\n"] );
}

Print_Message( "=", ["${DNSQuery_Retry_Max}th packet PASS\n"] );



#NOTREACHED

DNSExit($OK);
__END__
#######################################################

=head1 NAME

	CL_RFC1123_6_1_3_3_Cache_tmp_fail - Caching of temporary failure


=head1 VERIFICATION POINTS

	Verify that a NUT caches of temporary failure

=begin html
	<UL>
	<DD><li>All DNS name servers and resolvers SHOULD cache temporary failures, 
	<DD>with a timeout period of the order of minutes.
	</li>
	</ul> 

=end html

=head1 TARGET

	Client (with caching function)

=head1 SYNOPSIS

=begin html
<PRE>
	<A HREF="./CL_RFC1123_6_1_3_3_Cache_tmp_fail.seq">CL_RFC1123_6_1_3_3_Retrans_control.seq</A> [-tooloption ...]: KOI tool option
	See also <A HREF="../DNSConfig.pm">DNSConfig.pm</A>
</PRE>

=end html

=head1 INITIALIZATION

=begin html
	<ul>
	<li><STRONG>Network Topology</STRONG></li> 
	<PRE>
        AP Server1(TN):A.example.com     DNS Server1(TN)
          |3ffe:501:ffff:101::10           |3ffe:501:ffff:101::20
          |192.168.1.10                    |192.168.1.20
          |                                |
Net-y   --+--------+-----------------------+-------- 3ffe:501:ffff:101::/64 
                   |                                 192.168.1/24
                   |
                   |
                 ROUTER1(TN)
                   |3ffe:501:ffff:100::1
                   |192.168.0.1
                   |
Net-z   --+--------+-------------------------------- 3ffe:501:ffff:100::/64 
          |                                          192.168.0/24
        DNS Client1(NUT)
           3ffe:501:ffff:100:XXXX
           192.168.0.10
	<BR>
	XXXX: EUI64 address
	</PRE>
	<p></p>
	<li><STRONG>Setup</STRONG></li>
	<PRE>
	Set the DNS Server1(TN)'s address on NUT as above mentioned Network Topology.
	Set the limit of retransmission query on NUT(This limitation is assumed to be "N").
	</PRE>
	<p></p>
	<LI><STRONG>Pre-Sequence</STRONG></LI><p><PRE>
	In order to send the query for A type of AP Server1(TN):A.example.com to the DNS Server1(TN), 
	NUT is configured.
	</PRE>
	</UL>

=end html

=head1 TEST PROCEDURE

=begin html
<PRE>
	This test sequence is following.
<BR>
    DNS Client1 (NUT)                        DNS Server1 (TN)
        |                                              |
        |--------------------------------------------->|
        |           1. Send standard query             |
        |                                              |
        //                                            //
        |                                              |
        |--------------------------------------------->|
        |           N. Send standard query             |
        |                                              |
        |------------------------------------------> X |
        |           N+1. Send standard query           |
        |                                              |
        |------------------------------------------> X |
        |           N+2. Send standard query           |
        |                                              |
        v                                              v
<BR>
	1. NUT send standard query to TN.
                  Judgment (Check *1)
	N. NUT send standard query to TN.*Send query automatically.
                  Judgment (Check *N)
	N+1. NUT send standard query to TN.*Send query automatically.
                  Judgment (Check *N+1)
	N+2. NUT send standard query to TN.
                  Judgment (Check *N+2)
<ul>
Packet Description
1st to N th Packet
	<table border="1">
	  <tbody>
	    <tr>
	      <td colspan="3">
	      <center>Standard query from DNS Client1 (NUT) to DNS Server1 (TN) </center>
	      </td>
	    </tr>
	    <tr>	      <td rowspan="2">IP Header</td>
	      <td>Source Address</td>
	      <td>NUT_NETZ</td>
	    </tr>
	    <tr>
	      <td>Destination Address</td>
	      <td>BRO_MULTI</td>
	    </tr>
	    <tr>
	      <td colspan="1" rowspan="2">UDP Header<br>
	      </td>
	      <td>Src Port<br>
	      </td>
	      <td><i>any</i><br>
	      </td>
	    </tr>
	    <tr>
	      <td>Dst Port<br>
	      </td>
	      <td>53<br>
 	     </td>
	    </tr>
 	   <tr>
 	     <td colspan="1" rowspan="13">DNS Header<br>
 	     </td>
 	     <td>ID</td>
	      <td><i>any</i></td>
	    </tr>
	    <tr>
	      <td>QR<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td>OPCODE<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td>AA<br>
	      </td>
	      <td><i>any</i><br>
	      </td>
	    </tr>
	    <tr>
	      <td>TC</td>
	      <td>0</td>
	    </tr>
	    <tr>
	      <td>RD</td>
	      <td>0</td>
	    </tr>
	    <tr>
	      <td>RA<br>
	      </td>
	      <td><i>any</i><br>
	      </td>
	    </tr>
	    <tr>
	      <td>Z<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td>RCODE<br>
	      </td>
 	     <td><i>any</i><br>
	      </td>
	    </tr>
	    <tr>
	      <td>QDCOUNT<br>
	      </td>
	      <td>1<br>
	      </td>
 	   </tr>
	    <tr>
	      <td>ANCOUNT<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td>NSCOUNT<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td>ARCOUNT<br>
	      </td>
	      <td>0<br>
	      </td>
	    </tr>
	    <tr>
	      <td colspan="1" rowspan="3">DNS Question section<br>
	      </td>
	      <td>QNAME</td>
	      <td>A.example.com<br>
	      </td>
	    </tr>
	    <tr>
	      <td>QTYPE<br>
	      </td>
	      <td>A (0x0001)<br>
	      </td>
	    </tr>
	    <tr>
	      <td>QCLASS<br>
	      </td>
	      <td><i>any</i><br>
	      </td>
	    </tr>
	  </tbody>
	</table>
NUT_NETZ : DNS Client1(NUT)'s address
SV_NETY : DNS Server1(TN)'s address
</ul>
</PRE>

=end html

=head1 JUDGMENT

        1. Received standard query from NUT.
        2. Received standard query from NUT.
        N. Received standard query from NUT.
        N+1. Not received standard query from NUT.
        N+2. Not received standard query from NUT.

=head1 TERMINATION

	If NUT has cache function, clear the cache.

=head1 REFERENCE

=begin html
<PRE>
	RFC1123 Requirements for internet Hosts -- Application and Support
	6.1.3.3  Efficient Resource Usage
</PRE>

=end html

=cut
